{"version":3,"file":"tenacious-fetch.umd.js","sources":["../src/retrying-fetch.js","../src/backoff.js","../src/index.js"],"sourcesContent":["import {linear, exponential} from './backoff'\n\nexport default function retryingFetch (retries, url, config) {\n  return new Promise((resolve, reject) => {\n    function fetchAttempt (url, config, retriesLeft) {\n      let {retryStatus, fetcher} = config\n      fetcher(url, config)\n        .then(res => {\n          if (retryStatus.includes(res.status)) {\n            // TODO: - Remove repetition\n            const error = new Error(`Request failed with status code ${res.status}`)\n            error.response = res\n            if (retriesLeft > 0) {\n              retriesLeft--\n              const retryDelay = getRetryDelay(config, retriesLeft)\n\n              if (config.onRetry && typeof config.onRetry === 'function') {\n                config.onRetry({retriesLeft, retryDelay, error})\n              }\n\n              setTimeout(() => fetchAttempt(url, config, retriesLeft), retryDelay)\n            } else {\n              reject(error)\n            }\n          } else {\n            resolve(res)\n          }\n        })\n        .catch(error => {\n          if (retriesLeft > 0) {\n            // TODO: - Remove repetition\n            retriesLeft--\n            const retryDelay = getRetryDelay(config, retriesLeft)\n\n            if (config.onRetry && typeof config.onRetry === 'function') {\n              config.onRetry({retriesLeft, retryDelay, error})\n            }\n\n            setTimeout(() => fetchAttempt(url, config, retriesLeft), retryDelay)\n          } else {\n            reject(error)\n          }\n        })\n    }\n\n    fetchAttempt(url, config, retries)\n  })\n}\n\nfunction getRetryDelay ({retryDelay, factor, retries, retryDelayFn}, retriesLeft) {\n  if (typeof retryDelayFn === 'function') {\n    return retryDelayFn(retries - retriesLeft)\n  }\n  if (factor && typeof factor === 'number' && Number.isInteger(factor)) {\n    return exponential(factor, retries - retriesLeft)\n  }\n  return linear(retryDelay, retries - retriesLeft)\n}\n","export function linear (initialVal, attempt) {\n  return initialVal * attempt\n}\n\nexport function exponential (factor, attempt) {\n  return Math.pow(factor, attempt)\n}\n","import retryingFetch from './retrying-fetch'\n\nlet browserFetch = false\n\ntry {\n  browserFetch = window && window.fetch\n} catch (error) {}\n\nfunction tenaciousFetch (url = '', config = {}) {\n  config = Object.assign({\n    retries: 1,\n    retryDelay: 1000,\n    retryStatus: [],\n    fetcher: browserFetch,\n    timeout: undefined\n  }, config)\n\n  if (!config.fetcher || typeof config.fetcher !== 'function') {\n    throw new Error(\n      'tenacious-fetch: No fetch implementation found. Provide a valid fetch implementation via the fetcher configuration property.'\n    )\n  }\n\n  if (typeof config.retryStatus === 'string' || typeof config.retryStatus === 'number') {\n    config.retryStatus = [Number.parseInt(config.retryStatus)]\n  }\n\n  const timeout = config.timeout\n\n  if (timeout && Number.isInteger(timeout)) {\n    return Promise.race([\n      retryingFetch(config.retries, url, config),\n      new Promise((resolve, reject) =>\n        setTimeout(\n          () =>\n            reject(\n              new Error(\n                `tenacious-fetch: Request took longer than timeout of ${timeout} ms.`\n              )\n            ),\n          timeout\n        )\n      )\n    ])\n  }\n\n  return retryingFetch(config.retries, url, config)\n}\n\nexport default tenaciousFetch\n"],"names":["retryingFetch","retries","url","config","Promise","resolve","reject","fetchAttempt","retriesLeft","retryStatus","fetcher","then","res","includes","status","const","error","Error","response","retryDelay","getRetryDelay","onRetry","setTimeout","catch","ref","factor","retryDelayFn","Number","isInteger","attempt","Math","pow","exponential","let","browserFetch","window","fetch","Object","assign","timeout","undefined","parseInt","race"],"mappings":"6KAEe,SAASA,EAAeC,EAASC,EAAKC,GACnD,OAAO,IAAIC,iBAASC,EAASC,IAC3B,SAASC,EAAcL,EAAKC,EAAQK,GAClC,IAAKC,iBACLC,aAAQR,EAAKC,GACVQ,cAAKC,GACJ,GAAIH,EAAYI,SAASD,EAAIE,QAAS,CAEpCC,IAAMC,EAAQ,IAAIC,yCAAyCL,UAE3D,GADAI,EAAME,SAAWN,EACbJ,EAAc,EAAG,CAEnBO,IAAMI,EAAaC,EAAcjB,IADjCK,GAGIL,EAAOkB,SAAqC,mBAAnBlB,EAAOkB,SAClClB,EAAOkB,qBAASb,aAAaW,QAAYH,IAG3CM,6BAAiBf,EAAaL,EAAKC,EAAQK,IAAcW,QAEzDb,EAAOU,QAGTX,EAAQO,KAGXW,eAAMP,GACL,GAAIR,EAAc,EAAG,CAGnBO,IAAMI,EAAaC,EAAcjB,IADjCK,GAGIL,EAAOkB,SAAqC,mBAAnBlB,EAAOkB,SAClClB,EAAOkB,qBAASb,aAAaW,QAAYH,IAG3CM,6BAAiBf,EAAaL,EAAKC,EAAQK,IAAcW,QAEzDb,EAAOU,KAKfT,CAAaL,EAAKC,EAAQF,KAI9B,SAASmB,EAAeI,EAA6ChB,OAA5CW,eAAYM,WAAQxB,YAASyB,iBACpD,MAA4B,mBAAjBA,EACFA,EAAazB,EAAUO,GAE5BiB,GAA4B,iBAAXA,GAAuBE,OAAOC,UAAUH,GCjD/D,SAA6BA,EAAQI,GACnC,OAAOC,KAAKC,IAAIN,EAAQI,GDiDfG,CAAYP,EAAQxB,EAAUO,GAEzBW,GAAYlB,EAAUO,GEtDtCyB,IAAIC,GAAe,EAEnB,IACEA,EAAeC,QAAUA,OAAOC,YACzBpB,WAET,SAAyBd,EAAUC,GASjC,kBAT6B,yBAC7BA,EAASkC,OAAOC,QACdrC,QAAS,EACTkB,WAAY,IACZV,eACAC,QAASwB,EACTK,aAASC,GACRrC,IAESO,SAAqC,mBAAnBP,EAAOO,QACnC,MAAM,IAAIO,MACR,gIAI8B,iBAAvBd,EAAOM,aAA0D,iBAAvBN,EAAOM,cAC1DN,EAAOM,aAAekB,OAAOc,SAAStC,EAAOM,eAG/CM,IAAMwB,EAAUpC,EAAOoC,QAEvB,OAAIA,GAAWZ,OAAOC,UAAUW,GACvBnC,QAAQsC,MACb1C,EAAcG,EAAOF,QAASC,EAAKC,GACnC,IAAIC,iBAASC,EAASC,UACpBgB,6BAEIhB,EACE,IAAIW,8DACsDsB,YAG9DA,OAMDvC,EAAcG,EAAOF,QAASC,EAAKC"}